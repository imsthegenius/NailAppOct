# Expo Dev Client on SDK 53 + iOS 18 — Findings and Recommendations

## Executive Summary
- The 6.x Expo Dev Client aligns with React Native 0.80+/Expo SDK 55+. On SDK 53 (RN 0.79.5), 6.x triggers compile-time failures (SwiftUI `Color.expo*` helpers and `RCTReleaseLevel` APIs) that indicate a native API mismatch.
- Short-term, the least risky path is to run the SDK 53–compatible dev client 5.x with pods pinned and re-test on iOS 18. If it still crashes, capture the exact crash log to determine whether there’s a 5.x patch or config-level fix.
- Medium-term, the recommended path is upgrading the app to Expo SDK 55+ (RN 0.80+), which natively supports the 6.x dev client and removes the need for custom postinstall patches.
- Continuing to patch 6.x sources on SDK 53 is brittle and should be a last resort.

## Environment Snapshot (from project brief)
- Expo SDK: `~53.0.22` (RN `0.79.5`)
- Dev Client: `expo-dev-client@^6.0.12` (attempted upgrade)
- Hermes: enabled; iOS deployment target 15.1
- Pods: pinned to local `ExpoModulesCore`, `ExpoBlur` to avoid EAS drift
- Postinstall: rewrites SwiftUI color helpers and shims `RCTReleaseLevel` usage

## Observed Failures (from project brief)
1) SwiftUI color helpers missing
- Error: `type 'Color' has no member 'expoSecondarySystemBackground'` (and similar)
- Location: `expo-dev-menu` / `expo-dev-launcher` SwiftUI files
- Likely cause: helpers shipped with newer ExpoModulesCore (SDK 55+), not present in SDK 53

2) Missing `RCTReleaseLevel` APIs in `EXDevLauncherController`
- Errors: `expected a type`, `use of undeclared identifier 'RCTReleaseLevel'`, `initWithDelegate:releaseLevel:` selector not found
- Likely cause: the API exists in RN 0.80+, not in RN 0.79.5 bundled with SDK 53

3) Historical pod drift producing Swift helper errors in EAS
- Fixed by pinning `:path => '../node_modules/...` and committing `Podfile.lock`

4) Sandbox network limits
- Prevent external validation in the current environment; docs/issues must be verified locally

## What We Intended To Verify (citations pending — network blocked)
- Dev Client 6.x requires RN 0.80+ and is paired with Expo SDK 55+.
- `RCTReleaseLevel` and related initializer landed in RN 0.80 (or around that), not in 0.79.x.
- SwiftUI `Color.expo*` extensions are defined in newer `ExpoModulesCore` and used by dev menu/launcher in 6.x.
- iOS 18–specific crash in Dev Client 5.x: whether there’s a 5.2.x patch or config fix that resolves launch crashes without moving to 6.x.
- Official Expo guidance for using Dev Client with older SDKs on iOS 18: whether they recommend staying on 5.x or upgrading SDK.

Suggested sources to check:
- Expo Dev Client changelog and release notes
- React Native 0.80 release notes for `RCTReleaseLevel`
- Expo Forums discussions: “iOS 18 dev client crash”, “SDK 53 dev client 6”, “Color.expoSecondarySystemBackground”
- GitHub issues in `expo/expo` and `expo/expo-dev-client`

## Recommendations

### Path A — Revert to the SDK 53–compatible Dev Client (5.x)
Goal: Restore a working iOS dev client without patching upstream code.

Steps:
- Set `expo-dev-client` to the last SDK 53–compatible 5.x release (e.g., `~5.2.x`).
- Ensure pods are pinned to local node_modules paths for `ExpoModulesCore` (and other Expo pods) and commit `Podfile.lock`.
- Clean and reinstall pods: remove `ios/Pods`, then `cd ios && pod install`.
- Build and launch on iOS 18 with Xcode attached to capture logs.
- If a launch crash persists:
  - Capture the full crash/crashlog + device OS version.
  - Try the most recent 5.x patch release (if available) to check for an iOS 18 backport.
  - Check for known conflicts (e.g., older config plugins or postinstall scripts touching dev menu files) and disable any custom patching when on 5.x.

When to choose Path A:
- You need a quick, low-risk dev loop on iOS while keeping SDK 53 for the current release cycle.

Risks:
- If the iOS 18 crash is only fixed in Dev Client 6.x (and not backported), Path A may still block you.

### Path A0 — First Principles: Run Without expo-dev-client
Goal: Get a reliable development loop on iOS 18 today, avoiding all dev‑client native code and patches. This is the simplest route to iterate on app code while staying on SDK 53.

What this is: a plain React Native Debug build of your app (generated by Expo prebuild) running against Metro. You won’t have the Expo Dev Launcher UI, but you do have the standard RN dev menu (shake to open), fast refresh, and debugger.

Steps (no code edits required):
- Ensure the native project exists: `npx expo prebuild --platform ios` (skip if `ios/` already exists and matches your current app config).
- Start Metro separately: `npx react-native start --reset-cache` (or `EXPO_NO_DEV_CLIENT=1 npx expo start --clear`).
- Open `ios/*.xcworkspace` in Xcode, select your app target (not any Dev Client/Launcher target), set the scheme to Debug, choose your iOS 18 device, and press Run.
- Use the RN dev menu (shake device) for Reload, Fast Refresh, and Dev Settings.

Notes:
- This bypasses expo-dev-client entirely, eliminating the Swift color helpers and `RCTReleaseLevel` issues.
- If you rely on features specific to the Dev Launcher (e.g., opening arbitrary projects via QR), those won’t be available; for most day‑to‑day app dev, this is sufficient.
- Keep `Podfile.lock` committed and pods pinned to local paths to avoid EAS runner drift even when not using dev‑client.

When to choose Path A0:
- You need an immediate, stable dev loop on iOS 18 without touching upstream Expo native sources.

Tradeoffs:
- No Dev Launcher UI; otherwise the developer experience is comparable for a single app.

### Path B — Upgrade the Project to Expo SDK 55+
Goal: Align with the native APIs expected by Dev Client 6.x (RN 0.80+), removing the compile-time errors and custom shims.

High-level steps:
- Run `npx expo upgrade` to move to SDK 55+ (which brings RN 0.80+).
- Upgrade `expo-dev-client` to `^6.x`.
- Keep pods pinned to local node_modules to avoid EAS drift; reinstall pods.
- Remove postinstall shims for SwiftUI color helpers and `RCTReleaseLevel` — they should no longer be necessary.
- Validate iOS dev build on iOS 18 devices; confirm dev menu/launcher render.

When to choose Path B:
- You can afford a migration cycle and want to get off brittle patches.

Risks:
- SDK upgrade can surface other breaking changes; requires thorough testing.

### Path C — Minimal Patch Forward on SDK 53 (Last Resort)
Goal: Keep Dev Client 6.x on SDK 53 with targeted shims.

Constraints and notes:
- Replace SwiftUI `Color.expo*` references with system colors via `Color(UIColor.*)` or backport the helpers in a local extension.
- Wrap `EXDevLauncherController` initialization so it only calls `initWithDelegate:releaseLevel:` when the symbol exists; otherwise use `initWithDelegate:`. Prefer compile-time availability checks over runtime selector calls.
- Use `patch-package` to maintain diffs rather than postinstall file rewrites where possible.

Risks:
- High maintenance. Any upstream update to dev menu/launcher files can break patches.
- You are running against a mismatched native API surface; subtle regressions are possible.

## Decision Guidance
- If 5.x runs on iOS 18 after pod pinning and a clean install, adopt Path A immediately for short-term productivity, then schedule Path B.
- If 5.x still crashes on iOS 18 and there’s no backported fix, skip to Path B. Avoid Path C unless absolutely blocked by timelines.

## Verification Plan
- iOS build: clean derived data, `pod deintegrate && pod install`, build in Xcode with scheme set to the dev client target, device on iOS 18.
- Confirm Dev Menu appears and `expo-dev-launcher` UI renders.
- If a crash occurs:
  - Collect Xcode logs and any `.crash` reports from `Devices and Simulators`.
  - Note Dev Client version, iOS version, device model, and last log message.

### Zero‑Patch Troubleshooting Checklist (for A0/A/B)
- Clean Xcode DerivedData for the project, then rebuild.
- Remove `ios/Pods` and `Podfile.lock`, `pod deintegrate`, then `pod install` with your pinned pods.
- Ensure `RCT_NEW_ARCH_ENABLED=0` during pod install on RN 0.79.x unless you have intentionally enabled it.
- Verify Hermes is enabled/disabled consistently across Debug/Release as intended.
- Start Metro with a clear cache and confirm the packager URL matches the running device.
- If using `expo-updates`, disable it for Debug or ensure it does not attempt to load an older embedded bundle.

## Open Items To Confirm (fill with citations)
- Is there an official Expo statement that Dev Client 6.x requires RN 0.80+/SDK 55+? [REF]
- RN version where `RCTReleaseLevel` and `initWithDelegate:releaseLevel:` were introduced. [REF]
- ExpoModulesCore version introducing SwiftUI `Color.expo*` extensions and which SDK they shipped in. [REF]
- Any known issue or patch release addressing an iOS 18 launch crash for Dev Client 5.x. [REF]
- Expo’s recommended stance: stay on 5.x for SDK 53 or upgrade SDK for iOS 18. [REF]

## Next Steps
- Re-test `expo-dev-client@~5.2.x` on iOS 18 with clean pods and no custom patches; share crash logs if it fails.
- If crash-free, proceed with Path A and plan migration to SDK 55+.
- If crashing, prioritize Path B and set aside patch maintenance.

---

Notes:
- Sandbox blocked outbound requests; once network is enabled I’ll fill in the citations with specific forum threads, changelog entries, and RN release notes and update this document.

## Change Plan — 2025-09-17

Status: Documentation only. No code changes applied yet.

Objective: Ship a reliable iOS internal build for on‑device payments testing and restore a simple dev loop on iOS 18 without expo‑dev‑client. Eliminate brittle patches tied to SDK 53/RN 0.79.5.

Planned changes (with reasons, risks, rollback)

1) Remove `expo-dev-client` from app dependencies
- Files: `nail-app-mobile/package.json`
- Change: delete `"expo-dev-client": "^6.0.12"` from `dependencies`.
- Reason: Dev Client 6.x expects RN 0.80+/SDK 55+ and causes native symbol/SwiftUI helper errors on SDK 53. Not required for payments or local Debug builds via Xcode.
- Risk: Dev Launcher UI not available; day‑to‑day dev uses RN dev menu instead.
- Rollback: Re‑add dependency and reinstall. Revisit after upgrading to SDK 55+.

2) Stop running the Dev Client SwiftUI patch on postinstall
- Files: `nail-app-mobile/package.json`, `nail-app-mobile/scripts/patch-expo-dev-client-swiftui.js`
- Change: remove `&& node scripts/patch-expo-dev-client-swiftui.js` from `scripts.postinstall`; optionally remove the script file.
- Reason: Patch becomes unnecessary after removing dev client, and was brittle against upstream changes.
- Risk: None once dev client is removed.
- Rollback: Restore the postinstall entry and script file.

3) Deprecate the EAS `development` (dev‑client) profile to avoid accidental use
- Files: `nail-app-mobile/eas.json`
- Change: either remove the `development` profile or set `developmentClient: false` and add a comment marking it deprecated.
- Reason: Prevents unintentionally building a dev client that will fail on SDK 53.
- Risk: Engineers expecting a dev client build via EAS may need to use Xcode Debug or the `preview`/`payments` profile instead.
- Rollback: Re‑enable or restore the profile config as before.

4) Add a `payments` EAS profile (copy of `preview`)
- Files: `nail-app-mobile/eas.json`
- Change: create a `payments` profile identical to `preview` (`distribution: internal`, `ios.image: sdk-53`, same cache key), so payment testing has a dedicated command.
- Reason: One‑click internal build for RevenueCat testing, separate from general preview builds.
- Risk: None; purely a convenience alias.
- Rollback: Remove the `payments` profile.

5) Keep the `expo-file-system` postinstall patch
- Files: `nail-app-mobile/scripts/patch-expo-file-system.js`
- Change: no change; retain the patch.
- Reason: It targets a known symbol name change and is unrelated to the dev client; it stabilizes builds on SDK 53.
- Risk: Low; patch is targeted and idempotent.
- Rollback: Remove the postinstall entry if upstream release resolves it.

6) Keep pods deterministic and aligned
- Files: `nail-app-mobile/ios/Podfile.lock`, `nail-app-mobile/ios/Podfile`, `nail-app-mobile/package.json (overrides)`
- Change: no change; continue committing `Podfile.lock`, keep `expo-modules-core` pinned to `2.5.0` and `image: sdk-53`.
- Reason: Prevents cloud/local drift that previously caused Swift/Obj‑C symbol errors.
- Risk: None; this is already the working setup.
- Rollback: N/A.

7) Add a 10‑minute “Payments Runbook” to the top of the clean build doc
- Files: `docs/EAS_IOS_CLEAN_BUILD.md`
- Change: prepend a concise runbook for building/installing an internal IPA and validating Sandbox purchases.
- Reason: Makes the working path obvious; avoids dev‑client confusion.
- Risk: None.
- Rollback: Revert the doc change if undesired.

Success criteria
- Internal iOS build (`eas build -p ios --profile payments`) installs and runs on iOS 18 devices; Sandbox purchases complete via RevenueCat.
- Local dev loop via Xcode Debug + Metro works without expo‑dev‑client; no Swift `Color.expo*` or `RCTReleaseLevel` errors encountered.
- No reliance on brittle postinstall patches except the scoped `expo-file-system` fix.

Notes
- We will not touch your app code or iOS native sources for this change set. All edits are small, targeted config/doc updates with clear rollback.
- After SDK upgrade to 55+, we can re‑introduce the dev client cleanly if needed.

### Change Plan Addendum — 2025-09-17 (Runtime Stabilization)

Status: Applied.

Objective: Eliminate the recurring “black screen on launch” and runtime instability by aligning with RN 0.79 expectations and disabling the experimental New Architecture on SDK 53.

Changes
1) Disable New Architecture
- Files: `nail-app-mobile/app.json: "newArchEnabled": false`, `nail-app-mobile/ios/Podfile.properties.json: "newArchEnabled": "false"`
- Reason: RCT New Architecture is experimental on RN 0.79 / SDK 53; enabling it is a common cause of startup crashes/black screens when dependent libraries are not all Fabric/Turbo ready.
- Risk: None for our use case; this restores the stable legacy architecture.
- Rollback: Set to true and reinstall pods (not recommended on SDK 53).

2) Align React version to RN 0.79 peer dependency
- Files: `nail-app-mobile/package.json` — keep `react` and `react-dom` on `19.0.0`.
- Reason: RN 0.79.5 declares a peer of `react@^19.0.0`; mismatching this causes npm resolution conflicts and can lead to runtime mismatches.
- Risk: Low; this satisfies RN’s stated peer range.
- Rollback: Not needed; only change if upgrading RN/SDK.

Required rebuild steps after these changes
- `cd nail-app-mobile && rm -rf node_modules ios/Pods && npm ci`
- `cd ios && pod deintegrate && pod install`
- For internal IPA: `eas build -p ios --profile payments --clear-cache`
- For local Debug: start Metro, open the workspace in Xcode, run Debug on device.

Expected outcome
- No black screen on internal builds; app boots to JS reliably.
- No new‑arch or React 19 related runtime crashes.

### Change Plan Addendum — 2025-09-17 (Build Stabilization)

Status: Applied.

Objective: Fix Metro bundling failures during `expo export:embed` by using Expo’s default transformer.

Changes
1) Remove incorrect Metro transformer override
- Files: `nail-app-mobile/metro.config.js`
- Change: remove `config.transformer.babelTransformerPath = require.resolve('react-native-reanimated/plugin')` and custom resolver; export Expo’s default config.
- Reason: `babelTransformerPath` expects a Metro transformer module, not a Babel plugin. Pointing it at Reanimated’s Babel plugin breaks bundling (`export:embed` exits with code 1). Reanimated is already configured via Babel plugin in `babel.config.js` and does not require a Metro transformer override.
- Risk: None; Expo’s default Metro config handles our use case.
- Rollback: Revert the file if a custom transformer is needed in future (e.g., for SVG transformer) with the correct module.

Required rebuild steps
- `cd nail-app-mobile && rm -rf node_modules && npm ci`
- Rebuild IPA: `eas build -p ios --profile payments --clear-cache`

Expected outcome
- `expo export:embed` completes; Hermes compiles the JS bundle; build proceeds to codesign.

### Change Plan Addendum — 2025-09-17 (Runtime Unblocker)

Status: Applied.

Objective: Prevent a perceived “black screen” during app bootstrap by rendering a visible loader and enforcing a conservative timeout so the app continues even if an async init stalls in release.

Changes
1) Show loading UI instead of returning null while booting
- Files: `nail-app-mobile/App.tsx`
- Change: render an ActivityIndicator on a light background when `isFirstLaunch` or `isAuthenticated` is `null`.
- Reason: Returning `null` paints a black screen in release, masking whether the app is actually progressing.

2) Add a 7s bootstrap timeout fallback
- Files: `nail-app-mobile/App.tsx`
- Change: after 7 seconds, coerce any remaining `null` bootstrap states to `false` so navigation can proceed.
- Reason: Guards against rare cases where an async init (e.g., auth/session read) hangs in release.
- Risk: If a genuine auth session exists but init is very slow, the app may start unauthenticated first; subsequent auth listener still updates state when it arrives.

Required rebuild steps
- `cd nail-app-mobile && npm ci`
- Rebuild IPA: `eas build -p ios --profile payments --clear-cache`

Expected outcome
- No black screen; a spinner shows during boot, and the app proceeds to Splash/Main even if an init stalls.

### Change Plan Addendum — 2025-09-17 (Initial Route + Camera Permission)

Status: Applied.

Objective: Eliminate blank screen caused by landing on Camera screen before camera permission state is known.

Changes
1) Start Main navigator on Design, not Camera
- Files: `nail-app-mobile/navigation/MainNavigator.tsx`
- Change: `initialRouteName` from `Camera` to `Design`.
- Reason: CameraScreen returned an empty `<View />` while permission object was undefined, presenting as a blank screen. Starting on Design avoids this first‑launch edge.

2) Graceful permission handling in CameraScreen
- Files: `nail-app-mobile/screens/CameraScreen.tsx`
- Change: auto‑request camera permission on mount when permission is undefined; render a visible loader instead of an empty view during permission resolution.
- Reason: Prevents black screen while permission state initializes; ensures user sees progress and prompt.

Required validation
- Run a local Debug build (Xcode + Metro) to confirm splash → design renders; navigating to Camera prompts permission and shows loader.
- Then build an internal IPA (`payments` profile) if needed for purchase testing.

Expected outcome
- App no longer lands on a blank Camera screen on first launch; visible loader and permission prompt appear; design screen is the initial experience.

### Change Plan Addendum — 2025-09-17 (Launch Crash Fix)

Status: Applied.

Observed crash (from Xcode screenshot and device logs)
- `Exception: '-[EXExpoAppDelegate window]: unrecognized selector sent to instance'` during `application:didFinishLaunchingWithOptions:`.

Root cause
- Local file `ios/nailappmobile/ExpoAppDelegateShim.swift` defined a custom `ExpoAppDelegate` class that shadowed ExpoModulesCore’s real `ExpoAppDelegate`. The wrapper (`EXAppDelegateWrapper`) expects `window` and other selectors on the real class; the shim didn’t implement them, causing a selector crash at launch.

Change
- Deleted `ios/nailappmobile/ExpoAppDelegateShim.swift` from the app target.
- Reason: We already patch `expo-file-system` to use `ExpoAppDelegateSubscriberRepository` and do not need any local `ExpoAppDelegate` shim. Removing it restores the real ExpoModulesCore implementation.

Required steps after change
- Clean build folder in Xcode (Product → Clean Build Folder) and rebuild.

Expected outcome
- Launch crash disappears; app proceeds to React bootstrap where the loader renders, then Splash → Design.
